#! /bin/bash

join_list=""
scan_list=""
log_level=info
log_dir=/var/log/serf
docker_sock=/var/run/docker.sock

mkdir -p ${log_dir} 2>/dev/null
chown serf ${log_dir} 2>/dev/null

# Start Serf
if [ -n "${DEBUG}" ]; then
  log_level=debug
  exec 1>&-
  exec 2>&-
  exec 1>>${log_dir}/serf.stdout
  exec 2>>${log_dir}/serf.stderr
  set -x
fi

node_name=${NODE_NAME:-$(hostname -s)}

rpc_port=${RPC_PORT:-7373}
rpc_ip=${RPC_IP:-127.0.0.1}

bind_port=${BIND_PORT:-7946}
bind_ip=${BIND_IP:-0.0.0.0}

advertise_port=${ADVERTISE_PORT:-${bind_port}}
advertise_ip=${ADVERTISE_IP:-$(hostname -i | awk '{print $1}')}

# If we are in BRIDGE mode, try to translate port
#
if [ -z "$(ip -o link show dev docker0 2>/dev/null)" ]; then 
  echo BRIDGE Mode

  # If the docker socket exposed to us (useful for bridge mode) then try to discover the external port this container is listening on
  #
  if [ -S ${docker_sock} ]; then

    # Use docker container info to find out the mapped port for the bind_port
    #
    json=$( echo -e "GET /containers/$(hostname -s)/json HTTP/1.1\\n\\n" | socat unix-connect:${docker_sock} STDIO | grep '^[\[{]' )
    if [ -z "${ADVERTISE_PORT}" -a -n "${json}" ]; then
      echo ${json} | jq . >>${log_dir}/serf.log
      answer=$( echo ${json} | jq .NetworkSettings.Ports[\"${bind_port}/tcp\"][].HostPort | sed -e 's/^"//' -e 's/"$//' )
      advertise_port=${answer:-${advertise_port}}
    fi

    # Use docker info to figure out the docker host's name and then use ping to transform to the IP address
    #
    json=$( echo -e "GET /info HTTP/1.1\\n\\n" | socat unix-connect:${docker_sock} STDIO | grep '^[\[{]' )
    if [ -z "${ADVERTISE_IP}" -a -n "${json}" ]; then
      echo ${json} | jq . >>${log_dir}/serf.log
      docker_hostname=$( echo ${json} | jq .Name | sed -e 's/^"//' -e 's/"$//' )
      answer=$(ping -n -c 1 -w 1 ${docker_hostname} | grep ^PING | cut -d\( -f 2 | cut -d\) -f1)
      advertise_ip=${answer:-${advertise_ip}}

      # Add the learned docker host IP server to the join list at the same bind port
      #
      join_list="${join_list} -join=${answer}:${bind_port}" 
    fi
  fi

# Otherwise, we are in HOST mode, see if we should discover our peers
#
else
  echo HOST Mode

  # If PORT_SCAN is enabled, use nmap to find our peers within our network
  # keep expanding the netmask till we find a peer that might want to talk to us
  # netmask cannot be smaller than 16
  #
  if [ -n "${PORT_SCAN}" ]; then
    device=$(ip -o route get 8.8.8.8 | sed -e 's/^.*dev //' -e 's/ .*//')
    base=$(ip addr show dev ${device} | grep "inet " | awk '{print $2}' | cut -d/ -f1)
    mask=$(ip addr show dev ${device} | grep "inet " | awk '{print $2}' | cut -d/ -f2)

    # if PORT_SCAN_MASK is subnet, set it to the discovered mask for this host
    #	
    [ "${PORT_SCAN_MASK}" == "subnet" ] && PORT_SCAN_MASK=${mask}

    # if PORT_SCAN_MASK is set, use it as the widest mask, otherwise its set to 16
    #
    mask_limit=${PORT_SCAN_MASK:-${mask}}

    # If mask_limit is wider than 16 reset the limit
    #
    [ "${mask_limit}" -lt 16 ] && mask_limit=16

    # if the starting mask is wider than the mask limit
    # change the starting mask to the mask limit so it at least runs once
    #
    [ "${mask}" -lt "${mask_limit}" ] && mask=${mask_limit}

    while [ -z "${scan_list}" -a ${mask} -ge ${mask_limit} ]; do
      for host in $( nmap --open --send-ip --unprivileged -n -p${bind_port} -oG - ${base}/${mask} \
      | grep "^Host" | grep ${bind_port} | awk '{print $2}' ); do
        scan_list="${scan_list} -join=${host}:${bind_port}" 
      done
      mask=$((mask-2))
    done
  fi

fi

# If a JOIN_LIST was specified then add those nodes to the agent run command
# Use nmap to see if its accepting connections, because if you attempt to join
# a non-responding node, it causes issues
#
if [ -n "${JOIN_LIST}" ]; then
  for host in $(echo ${JOIN_LIST} | tr ',' ' '); do
    for host in $( nmap --open --send-ip --unprivileged -n -p${bind_port} -oG - ${host}/32 \
    | grep "^Host" | grep ${bind_port} | awk '{print $2}' ); do
      join_list="${join_list} -join=${host}:${bind_port}" 
    done
  done
fi

exec /sbin/setuser serf \
  /usr/bin/serf agent \
  ${scan_list} \
  ${join_list} \
  -node="${node_name}" \
  -rpc-addr="127.0.0.1:${rpc_port}" \
  -rpc-addr="${rpc_ip}:${rpc_port}" \
  -bind="${bind_ip}:${bind_port}" \
  -advertise="${advertise_ip}:${advertise_port}" \
  -event-handler=/etc/service/serf/dispatcher.sh \
  -snapshot=${log_dir}/snapshot.dat \
  -tags-file=${log_dir}/tags.dat \
  -log-level=${log_level} \
  >>${log_dir}/serf.log 2>&1

